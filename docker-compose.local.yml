version: '3.3'
services:
    db:
        image: mariadb
        command: mysqld --character-set-serve=utf8mb4 --collation-server=utf8mb4_unicode_ci
        env_file: .env.db
        ports:
            - '${DB_BIND_PORT}:3306'
        volumes:
            - type: bind
              source: ./docker/db/var/lib/mysql
              target: /var/lib/mysql
    localstack:
        image: localstack/localstack
        ports:
            - '4567-4584:4567-4584'
            - '${LOCALSTACK_BIND_PORT}:${LOCALSTACK_BIND_PORT}'
        environment:
            - PORT_WEB_UI=${LOCALSTACK_BIND_PORT}
    web:
        build:
            context: .
            dockerfile: ./docker/web/Dockerfile
        command: sh -c './bin/wait-for-it.sh db:3306 -t 60; ./bin/entrypoint.local.sh'
        env_file:
            - .env.db
            - .env.web
        volumes:
            - type: bind
              source: ./src
              target: /src
        ports:
            - '${DJANGO_BIND_PORT}:8080'
        depends_on:
            - db
            - localstack
    nginx:
        image: nginx
        restart: always
        ports:
            - '${NGINX_BIND_PORT}:80'
        volumes:
            - type: bind
              source: ./docker/nginx/etc/nginx
              target: /etc/nginx
            - type: bind
              source: ./src/static
              target: /var/www/static
        depends_on:
            - web

